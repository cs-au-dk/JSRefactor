<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
	<head>
		<meta name="viewport" content="width=480, user-scalable=no" />
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="Content-Style-Type" content="text/css" />

		<script type="text/javascript">
            var MESH_IPOD = {
poss: [
-2.2599, 4.724999, -0.107207 /* 0 */ ,
-2.2599, -4.725001, -0.107207 /* 1 */ ,
2.2599, 4.724999, -0.107207 /* 2 */ ,
2.2599, -4.725001, -0.107207 /* 3 */ ,
-2.79, -5.250001, -0.067207 /* 4 */ ,
-2.79, 5.249999, -0.067207 /* 5 */ ,
2.79, 5.249999, -0.067207 /* 6 */ ,
2.79, -5.250001, -0.067207 /* 7 */ ,
-3.09, 5.294537, 0.274019 /* 8 */ ,
-3.09, -5.294799, 0.274019 /* 9 */ ,
2.923915, 5.5, 0.274019 /* 10 */ ,
-2.92233, 5.5, 0.274019 /* 11 */ ,
3.09, -5.294046, 0.274019 /* 12 */ ,
3.09, 5.294838, 0.274019 /* 13 */ ,
-2.923915, -5.5, 0.274019 /* 14 */ ,
2.922142, -5.5, 0.274019 /* 15 */ ,
3.1209, -5.219838, 0.192793 /* 16 */ ,
3.1209, 5.219842, 0.192793 /* 17 */ ,
-2.787396, -5.555, 0.192793 /* 18 */ ,
2.786741, -5.555, 0.192793 /* 19 */ ,
-3.120899, 5.22033, 0.192793 /* 20 */ ,
-3.120899, -5.219804, 0.192793 /* 21 */ ,
2.78749, 5.555001, 0.192793 /* 22 */ ,
-2.787022, 5.555001, 0.192793 /* 23 */ ,
3.1209, -5.219838, 0.092793 /* 24 */ ,
3.1209, 5.219842, 0.092793 /* 25 */ ,
-2.787396, -5.555, 0.092793 /* 26 */ ,
2.786741, -5.555, 0.092793 /* 27 */ ,
-3.120899, 5.220331, 0.092793 /* 28 */ ,
-3.120899, -5.219804, 0.092793 /* 29 */ ,
2.78749, 5.555001, 0.092793 /* 30 */ ,
-2.787023, 5.555001, 0.092793 /* 31 */ ,
2.923915, 5.49945, -0.007207 /* 32 */ ,
-2.92233, 5.49945, -0.007207 /* 33 */ ,
3.089791, -5.294547, -0.007207 /* 34 */ ,
3.089791, 5.295346, -0.007207 /* 35 */ ,
-2.923915, -5.499449, -0.007207 /* 36 */ ,
2.922142, -5.499449, -0.007207 /* 37 */ ,
-3.08979, 5.295041, -0.007207 /* 38 */ ,
-3.08979, -5.295308, -0.007207 /* 39 */ ,
-2.998433, 5.423433, -0.025491 /* 40 */ ,
-2.99839, -5.423398, -0.025499 /* 41 */ ,
2.998412, 5.423415, -0.025495 /* 42 */ ,
2.998309, -5.423329, -0.025516 /* 43 */ ,
-3.063193, 5.358914, -0.01253 /* 44 */ ,
-3.063193, 5.358914, 0.274018 /* 45 */ ,
3.064252, 5.357329, 0.274019 /* 46 */ ,
3.064252, 5.357329, -0.012318 /* 47 */ ,
-3.064252, -5.35729, 0.274019 /* 48 */ ,
-3.064252, -5.35729, -0.012318 /* 49 */ ,
3.063005, -5.358874, 0.274019 /* 50 */ ,
3.063005, -5.358874, -0.012567 /* 51 */ ,
-2.7, -3.7, 0.274019 /* 52 */ ,
2.7, -3.7, 0.274019 /* 53 */ ,
2.7, 3.7, 0.274019 /* 54 */ ,
-2.7, 3.7, 0.274018 /* 55 */ ,

-2.7, 3.7, 0.26 /* 56 */ ,
-2.7, -3.7, 0.26 /* 57 */ ,
2.7, 3.7, 0.26 /* 58 */ ,
2.7, -3.7, 0.26 /* 59 */ ,
-2.7, 0, 0.26 /* 60 */ ,
2.7, 0, 0.26 /* 61 */
],
face_groups: [
	[
		60, 58, 56,
		61, 58, 60,
		57, 61, 60,
		59, 61, 57
	],
	[
		15, 54, 53,
		15, 53, 52,
		15, 52, 14,
		52, 11, 14,
		14, 11, 45,
		14, 45, 48,
		48, 45, 8,
		48, 8, 9,
		12, 13, 46,
		12, 46, 50,
		50, 46, 10,
		50, 10, 15,
		15, 10, 54,
		54, 10, 55,
		55, 10, 11,
		52, 55, 11
	],
	[
		2, 3, 1,
		2, 1, 0,
		5, 6, 2,
		5, 2, 0,
		7, 3, 2,
		7, 2, 6,
		7, 4, 1,
		7, 1, 3,
		1, 4, 0,
		0, 4, 5,
		15, 14, 18,
		15, 18, 19,
		31, 30, 32,
		31, 32, 33,
		33, 32, 40,
		40, 32, 42,
		40, 42, 6,
		40, 6, 5,
		41, 49, 39,
		41, 39, 4,
		4, 39, 5,
		5, 39, 38,
		5, 38, 44,
		5, 44, 40,
		51, 43, 34,
		34, 43, 7,
		34, 7, 6,
		34, 6, 35,
		35, 6, 47,
		47, 6, 42,
		29, 21, 20,
		29, 20, 28,
		39, 29, 28,
		39, 28, 38,
		21, 9, 20,
		20, 9, 8,
		19, 18, 26,
		19, 26, 27,
		11, 10, 22,
		11, 22, 23,
		23, 22, 30,
		23, 30, 31,
		37, 36, 41,
		37, 41, 43,
		43, 41, 4,
		43, 4, 7,
		27, 26, 36,
		27, 36, 37,
		24, 34, 25,
		25, 34, 35,
		16, 24, 25,
		16, 25, 17,
		12, 16, 17,
		12, 17, 13,
		50, 15, 37,
		50, 37, 51,
		51, 37, 43,
		49, 48, 39,
		39, 48, 9,
		39, 9, 21,
		39, 21, 29,
		14, 48, 36,
		36, 48, 49,
		36, 49, 41,
		28, 20, 8,
		28, 8, 38,
		38, 8, 45,
		38, 45, 44,
		22, 10, 30,
		30, 10, 32,
		15, 19, 27,
		15, 27, 37,
		11, 23, 31,
		11, 31, 33,
		45, 11, 33,
		45, 33, 44,
		44, 33, 40,
		18, 14, 26,
		26, 14, 36,
		17, 25, 13,
		13, 25, 35,
		13, 35, 47,
		13, 47, 46,
		50, 51, 34,
		50, 34, 12,
		12, 34, 24,
		12, 24, 16,
		10, 46, 32,
		32, 46, 47,
		32, 47, 42
	]
]

};

var FLR_SIZ = 30;
var FLR_Y   = -9;
var FLR_H1  = 10;
var FLR_H2  = 7;
var MESH_floor = {
poss: [
	-FLR_SIZ  , FLR_Y, FLR_SIZ, // 0
	-FLR_SIZ/2, FLR_Y, FLR_SIZ,
	         0, FLR_Y, FLR_SIZ,
	 FLR_SIZ/2, FLR_Y, FLR_SIZ,
	 FLR_SIZ  , FLR_Y, FLR_SIZ,

	-FLR_SIZ  , FLR_Y, FLR_SIZ/2, // 5
	-FLR_SIZ/2, FLR_Y, FLR_SIZ/2,
	         0, FLR_Y, FLR_SIZ/2,
	 FLR_SIZ/2, FLR_Y, FLR_SIZ/2,
	 FLR_SIZ  , FLR_Y, FLR_SIZ/2,

	-FLR_SIZ  , FLR_Y, 0, // 10
	-FLR_SIZ/2, FLR_Y, 0,
	         0, FLR_Y, 0,
	 FLR_SIZ/2, FLR_Y, 0,
	 FLR_SIZ  , FLR_Y, 0,

// ----------------------------------

	-FLR_SIZ  , FLR_Y, 0, // 15
	-FLR_SIZ/2, FLR_Y, 0,
	         0, FLR_Y, 0,
	 FLR_SIZ/2, FLR_Y, 0,
	 FLR_SIZ  , FLR_Y, 0,

	-FLR_SIZ  , FLR_Y, -FLR_SIZ/2, // 20
	-FLR_SIZ/2, FLR_Y, -FLR_SIZ/2,
	         0, FLR_Y, -FLR_SIZ/2,
	 FLR_SIZ/2, FLR_Y, -FLR_SIZ/2,
	 FLR_SIZ  , FLR_Y, -FLR_SIZ/2,

	-FLR_SIZ  , FLR_Y, -FLR_SIZ, // 25
	-FLR_SIZ/2, FLR_Y, -FLR_SIZ,
	         0, FLR_Y, -FLR_SIZ,
	 FLR_SIZ/2, FLR_Y, -FLR_SIZ,
	 FLR_SIZ  , FLR_Y, -FLR_SIZ,

// ----------------------------------

	-FLR_SIZ  , FLR_Y+FLR_H1, FLR_SIZ, // 30
	-FLR_SIZ/2, FLR_Y+FLR_H1, FLR_SIZ,
	         0, FLR_Y+FLR_H1, FLR_SIZ,
	 FLR_SIZ/2, FLR_Y+FLR_H1, FLR_SIZ,
	 FLR_SIZ  , FLR_Y+FLR_H1, FLR_SIZ,

	-FLR_SIZ  , FLR_Y, FLR_SIZ, // 35
	-FLR_SIZ/2, FLR_Y, FLR_SIZ,
	         0, FLR_Y, FLR_SIZ,
	 FLR_SIZ/2, FLR_Y, FLR_SIZ,
	 FLR_SIZ  , FLR_Y, FLR_SIZ,

	 FLR_SIZ  , FLR_Y+FLR_H1, -FLR_SIZ, // 40
	 FLR_SIZ/2, FLR_Y+FLR_H1, -FLR_SIZ,
	         0, FLR_Y+FLR_H1, -FLR_SIZ,
	-FLR_SIZ/2, FLR_Y+FLR_H1, -FLR_SIZ,
	-FLR_SIZ  , FLR_Y+FLR_H1, -FLR_SIZ,

	 FLR_SIZ  , FLR_Y, -FLR_SIZ, // 45
	 FLR_SIZ/2, FLR_Y, -FLR_SIZ,
	         0, FLR_Y, -FLR_SIZ,
	-FLR_SIZ/2, FLR_Y, -FLR_SIZ,
	-FLR_SIZ  , FLR_Y, -FLR_SIZ,

// ----------------------------------

	 -FLR_SIZ, FLR_Y+FLR_H2,   -FLR_SIZ, // 50
	 -FLR_SIZ, FLR_Y+FLR_H2, -FLR_SIZ/2,
	 -FLR_SIZ, FLR_Y+FLR_H2,          0,
	 -FLR_SIZ, FLR_Y+FLR_H2,  FLR_SIZ/2,
	 -FLR_SIZ, FLR_Y+FLR_H2,    FLR_SIZ,

	 -FLR_SIZ, FLR_Y,   -FLR_SIZ, // 55
	 -FLR_SIZ, FLR_Y, -FLR_SIZ/2,
	 -FLR_SIZ, FLR_Y,          0,
	 -FLR_SIZ, FLR_Y,  FLR_SIZ/2,
	 -FLR_SIZ, FLR_Y,    FLR_SIZ,

	 FLR_SIZ, FLR_Y+FLR_H2,    FLR_SIZ, // 60
	 FLR_SIZ, FLR_Y+FLR_H2,  FLR_SIZ/2,
	 FLR_SIZ, FLR_Y+FLR_H2,          0,
	 FLR_SIZ, FLR_Y+FLR_H2, -FLR_SIZ/2,
	 FLR_SIZ, FLR_Y+FLR_H2,   -FLR_SIZ,

	 FLR_SIZ, FLR_Y,    FLR_SIZ, // 65
	 FLR_SIZ, FLR_Y,  FLR_SIZ/2,
	 FLR_SIZ, FLR_Y,          0,
	 FLR_SIZ, FLR_Y, -FLR_SIZ/2,
	 FLR_SIZ, FLR_Y,   -FLR_SIZ

],

texcoords: [
	0,    0.00,
	0,    0.25,
	0,    0.50,
	0,    0.75,
	0,    1.00,

	0.36328125, 0.00,
	0.36328125, 0.25,
	0.36328125, 0.50,
	0.36328125, 0.75,
	0.36328125, 1.00,

	0.7265624, 0.00,
	0.7265624, 0.25,
	0.7265624, 0.50,
	0.7265624, 0.75,
	0.7265624, 1.00,

	0.7265624, 1.00,
	0.7265624, 0.75,
	0.7265624, 0.50,
	0.7265624, 0.25,
	0.7265624, 0.00,

	0.36328125, 1.00,
	0.36328125, 0.75,
	0.36328125, 0.50,
	0.36328125, 0.25,
	0.36328125, 0.00,

	0,    1.00,
	0,    0.75,
	0,    0.50,
	0,    0.25,
	0,    0.00,

// wall
	0.7265626, 0.00,
	0.7265626, 0.25,
	0.7265626, 0.50,
	0.7265626, 0.75,
	0.7265626, 1.00,

	0.90625, 0.00,
	0.90625, 0.25,
	0.90625, 0.50,
	0.90625, 0.75,
	0.90625, 1.00,

	0.7265626, 0.00,
	0.7265626, 0.25,
	0.7265626, 0.50,
	0.7265626, 0.75,
	0.7265626, 1.00,

	0.90625, 0.00,
	0.90625, 0.25,
	0.90625, 0.50,
	0.90625, 0.75,
	0.90625, 1.00,


	1, 0.00,
	1, 0.25,
	1, 0.50,
	1, 0.75,
	1, 1.00,

	0.92, 0.00,
	0.92, 0.25,
	0.92, 0.50,
	0.92, 0.75,
	0.92, 1.00,

	1, 0.00,
	1, 0.25,
	1, 0.50,
	1, 0.75,
	1, 1.00,

	0.92, 0.00,
	0.92, 0.25,
	0.92, 0.50,
	0.92, 0.75,
	0.92, 1.00

],

face_groups: [
	[
		 0,  1,  5,
		 5,  1,  6,
		 1,  2,  6,
		 6,  2,  7,
		 2,  3,  7,
		 7,  3,  8,
		 3,  4,  8,
		 8,  4,  9,

		 5,6,10,
		 10,6,11,
		 6,7,11,
		 11,7,12,
		 7,8,12,
		 12,8,13,
		 8,9,13,
		 13,9,14,

		 15,16,20,
		 20,16,21,
		 16,17,21,
		 21,17,22,
		 17,18,22,
		 22,18,23,
		 18,19,23,
		 23,19,24,

		 20,21,25,
		 25,21,26,
		 21,22,26,
		 26,22,27,
		 22,23,27,
		 27,23,28,
		 23,24,28,
		 28,24,29,


		 30, 31, 35,
		 35, 31, 36,
		 31, 32, 36,
		 36, 32, 37,
		 32, 33, 37,
		 37, 33, 38,
		 33, 34, 38,
		 38, 34, 39,

		 40, 41, 45,
		 45, 41, 46,
		 41, 42, 46,
		 46, 42, 47,
		 42, 43, 47,
		 47, 43, 48,
		 43, 44, 48,
		 48, 44, 49,


		 50, 51, 55,
		 55, 51, 56,
		 51, 52, 56,
		 56, 52, 57,
		 52, 53, 57,
		 57, 53, 58,
		 53, 54, 58,
		 58, 54, 59,

		 60, 61, 65,
		 65, 61, 66,
		 61, 62, 66,
		 66, 62, 67,
		 62, 63, 67,
		 67, 63, 68,
		 63, 64, 68,
		 68, 64, 69
	]
]

};
		</script>
		<script type="text/javascript">
/* MIT-LICENSE */
/*
Copyright (c) 2009 Satoshi Ueyama

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/

window.P3D = {
	texture: null,
	g: null
};

P3D.clear = function(f, w, h) {
	var g = this.g;
	g.beginPath();
	g.fillStyle = f;
	g.fillRect(0, 0, w, h);

}

P3D.num_cmp = function(a,b){return a-b;}

P3D.drawTriangle = function(poss, uvs, shade_clr) {
	var w = this.texture.width;
	var h = this.texture.height;

	var g = this.g;

	var vAd = [ poss[1].x - poss[0].x , poss[1].y - poss[0].y ];
	var vBd = [ poss[2].x - poss[0].x , poss[2].y - poss[0].y ];

	var vA = [ uvs[1].u - uvs[0].u , uvs[1].v - uvs[0].v ];
	var vB = [ uvs[2].u - uvs[0].u , uvs[2].v - uvs[0].v ];

	vA[0] *= w;
	vA[1] *= h;

	vB[0] *= w;
	vB[1] *= h;

	var m = new M22();
	m._11 = vA[0];
	m._12 = vA[1];
	m._21 = vB[0];
	m._22 = vB[1];

	var im = m.getInvert();
	if (!im) return false;

	var a = im._11 * vAd[0] + im._12 * vBd[0];
	var b = im._21 * vAd[0] + im._22 * vBd[0];

	var c = im._11 * vAd[1] + im._12 * vBd[1];
	var d = im._21 * vAd[1] + im._22 * vBd[1];

	var wu = uvs[0].u * w;
	var hv = uvs[0].v * h;
	var du = wu * a + hv * b;
	var dv = wu * c + hv * d;

	g.save();

	g.beginPath();
	g.moveTo(poss[0].x, poss[0].y);
	g.lineTo(poss[1].x, poss[1].y);
	g.lineTo(poss[2].x, poss[2].y);
	g.clip();

	g.transform(a, c, b, d, poss[0].x - du, poss[0].y - dv);

	// bounds
	var bx = [wu, wu+vA[0], wu+vB[0]];
	var by = [hv, hv+vA[1], hv+vB[1]];

	bx.sort(P3D.num_cmp);
	by.sort(P3D.num_cmp);

	var bw = bx[2] - bx[0];
	var bh = by[2] - by[0];

	if ((bx[0]+bw) <= (w-1)) bw++;
	if ((by[0]+bh) <= (h-1)) bh++;
	if (bx[0] >= 1) {bx[0]--; bw++;}
	if (by[0] >= 1) {by[0]--; bh++;}

	g.drawImage(this.texture, bx[0], by[0], bw, bh, bx[0], by[0], bw, bh);

	if (shade_clr) {
		g.fillStyle = shade_clr;
		g.fillRect(bx[0], by[0], bw, bh);
	}

	g.restore();

	return true;
}

P3D.drawTestByIndexBuffer = function(pos_buf, ix_buf, culling) {
	var g = this.g;

	if ((ix_buf.length%3) != 0)
		throw "invalid index buffer length!";

	var len = ix_buf.length/3;

	var i, ibase, vbase;
	var poss = [{},{},{}];
	g.strokeWidth = 1;
	for (i = 0, ibase = 0;i < len;++i)
	{
		vbase = ix_buf[ibase++] << 2;
		poss[0].x = pos_buf[vbase++];
		poss[0].y = pos_buf[vbase  ];

		vbase = ix_buf[ibase++] << 2;
		poss[1].x = pos_buf[vbase++];
		poss[1].y = pos_buf[vbase  ];

		vbase = ix_buf[ibase++] << 2;
		poss[2].x = pos_buf[vbase++];
		poss[2].y = pos_buf[vbase  ];

		// z component of cross product < 0 ?

		var Ax = poss[1].x - poss[0].x;
		var Ay = poss[1].y - poss[0].y;
		var Cx = poss[2].x - poss[1].x;
		var Cy = poss[2].y - poss[1].y;

		var cull = ( (((Ax * Cy) - (Ay * Cx))*culling) < 0);

		g.beginPath();
		g.strokeStyle = cull ? "#592" : "#0f0";
		g.moveTo(poss[0].x, poss[0].y);
		g.lineTo(poss[1].x, poss[1].y);
		g.lineTo(poss[2].x, poss[2].y);
		g.lineTo(poss[0].x, poss[0].y);
		g.stroke();
	}
}

P3D.drawByIndexBuffer = function(pos_buf, ix_buf, tx_buf, culling, z_clip) {
	var w, h;
	var color_polygon = !this.texture;
	if (this.texture) {
		w = this.texture.width;
		h = this.texture.height;
	}

	var g = this.g;
	var m = new M22();

	if (!culling) culling = 0;

	if ((ix_buf.length%3) != 0)
		throw "invalid index buffer length!";

	var i, ibase, vbase, tbase, poss = [{},{},{}];
	var len = ix_buf.length/3;
	var uv_0u, uv_0v, uv_1u, uv_1v, uv_2u, uv_2v;

	for (i = 0, ibase = 0;i < len;++i)
	{
		tbase = ix_buf[ibase++] << 1
		vbase = tbase << 1;
		poss[0].x = pos_buf[vbase++]; uv_0u = tx_buf[tbase++];
		poss[0].y = pos_buf[vbase++]; uv_0v = tx_buf[tbase];
		if (z_clip && (pos_buf[vbase] < 0 || pos_buf[vbase] > 1)) {ibase += 2; continue;}

		tbase = ix_buf[ibase++] << 1
		vbase = tbase << 1;
		poss[1].x = pos_buf[vbase++]; uv_1u = tx_buf[tbase++];
		poss[1].y = pos_buf[vbase++]; uv_1v = tx_buf[tbase];
		if (z_clip && (pos_buf[vbase] < 0 || pos_buf[vbase] > 1)) {++ibase; continue;}

		tbase = ix_buf[ibase++] << 1
		vbase = tbase << 1;
		poss[2].x = pos_buf[vbase++]; uv_2u = tx_buf[tbase++];
		poss[2].y = pos_buf[vbase++]; uv_2v = tx_buf[tbase];
		if (z_clip && (pos_buf[vbase] < 0 || pos_buf[vbase] > 1)) {continue;}

		var vAd = [ poss[1].x - poss[0].x , poss[1].y - poss[0].y ];
		var vBd = [ poss[2].x - poss[0].x , poss[2].y - poss[0].y ];

		var vCd = [ poss[2].x - poss[1].x , poss[2].y - poss[1].y ];

		// z component of cross product < 0 ?
		if( (((vAd[0] * vCd[1]) - (vAd[1] * vCd[0]))*culling) < 0)
			continue;

		if (color_polygon) {
			g.fillStyle = uv_0u;

			g.beginPath();
			g.moveTo(poss[0].x, poss[0].y);
			g.lineTo(poss[1].x, poss[1].y);
			g.lineTo(poss[2].x, poss[2].y);
			g.fill();
			continue;
		}

		var vA = [ uv_1u - uv_0u , uv_1v - uv_0v ];
		var vB = [ uv_2u - uv_0u , uv_2v - uv_0v ];

		vA[0] *= w;
		vA[1] *= h;

		vB[0] *= w;
		vB[1] *= h;

		m._11 = vA[0];
		m._12 = vA[1];
		m._21 = vB[0];
		m._22 = vB[1];

		var im = m.getInvert();
		if (!im) { continue;}

		var a = im._11 * vAd[0] + im._12 * vBd[0];
		var b = im._21 * vAd[0] + im._22 * vBd[0];

		var c = im._11 * vAd[1] + im._12 * vBd[1];
		var d = im._21 * vAd[1] + im._22 * vBd[1];

		var wu = uv_0u * w;
		var hv = uv_0v * h;
		var du = wu * a + hv * b;
		var dv = wu * c + hv * d;

		g.save();

		g.beginPath();
		g.moveTo(poss[0].x, poss[0].y);
		g.lineTo(poss[1].x, poss[1].y);
		g.lineTo(poss[2].x, poss[2].y);
		g.clip();
		g.transform(a, c, b, d, poss[0].x - du, poss[0].y - dv);

		// bounds
		var bx = [wu, wu+vA[0], wu+vB[0]];
		var by = [hv, hv+vA[1], hv+vB[1]];

		bx.sort(P3D.num_cmp);
		by.sort(P3D.num_cmp);

		var bw = bx[2] - bx[0];
		var bh = by[2] - by[0];

		if ((bx[0]+bw) <= (w-1)) bw++;
		if ((by[0]+bh) <= (h-1)) bh++;
		if (bx[0] >= 1) {bx[0]--; bw++;}
		if (by[0] >= 1) {by[0]--; bh++;}

		g.drawImage(this.texture, bx[0], by[0], bw, bh, bx[0], by[0], bw, bh);
/*
		if (shade_clr) {
			g.fillStyle = shade_clr;
			g.fillRect(bx[0], by[0], bw, bh);
		}
*/
		g.restore();

	}

}

function Vec3(_x, _y, _z)
{
	this.x = _x || 0;
	this.y = _y || 0;
	this.z = _z || 0;
}

Vec3.prototype = {
	zero: function() {
		this.x = this.y = this.z = 0;
	},

	sub: function(v) {
		this.x -= v.x;
		this.y -= v.y;
		this.z -= v.z;

		return this;
	},

	add: function(v) {
		this.x += v.x;
		this.y += v.y;
		this.z += v.z;

		return this;
	},

	copyFrom: function(v) {
		this.x = v.x;
		this.y = v.y;
		this.z = v.z;

		return this;
	},

	norm:function() {
		return Math.sqrt(this.x*this.x + this.y*this.y + this.z*this.z);
	},

	normalize: function() {
		var nrm = Math.sqrt(this.x*this.x + this.y*this.y + this.z*this.z);
		if (nrm != 0)
		{
			this.x /= nrm;
			this.y /= nrm;
			this.z /= nrm;
		}
		return this;
	},

	smul: function(k) {
		this.x *= k;
		this.y *= k;
		this.z *= k;

		return this;
	},

	dpWith: function(v)	{
		return this.x*v.x + this.y*v.y + this.z*v.z;
	},

	cp: function(v, w) {
		this.x = (w.y * v.z) - (w.z * v.y);
		this.y = (w.z * v.x) - (w.x * v.z);
		this.z = (w.x * v.y) - (w.y * v.x);

		return this;
	},

	toString: function() {
		return this.x + ", " + this.y + "," + this.z;
	}
}

function M44(cpy)
{
	if (cpy)
		this.copyFrom(cpy);
	else {
		this.ident();
	}
}

M44.prototype = {
	ident: function() {
			  this._12 = this._13 = this._14 = 0;
		this._21 =       this._23 = this._24 = 0;
		this._31 = this._32 =       this._34 = 0;
		this._41 = this._42 = this._43 =       0;

		this._11 = this._22 = this._33 = this._44 = 1;

		return this;
	},

	copyFrom: function(m) {
		this._11 = m._11;
		this._12 = m._12;
		this._13 = m._13;
		this._14 = m._14;

		this._21 = m._21;
		this._22 = m._22;
		this._23 = m._23;
		this._24 = m._24;

		this._31 = m._31;
		this._32 = m._32;
		this._33 = m._33;
		this._34 = m._34;

		this._41 = m._41;
		this._42 = m._42;
		this._43 = m._43;
		this._44 = m._44;

		return this;
	},

	transVec3: function(out, x, y, z) {
		out[0] = x * this._11 + y * this._21 + z * this._31 + this._41;
		out[1] = x * this._12 + y * this._22 + z * this._32 + this._42;
		out[2] = x * this._13 + y * this._23 + z * this._33 + this._43;
		out[3] = x * this._14 + y * this._24 + z * this._34 + this._44;
	},

	transVec3Rot: function(out, x, y, z) {
		out[0] = x * this._11 + y * this._21 + z * this._31;
		out[1] = x * this._12 + y * this._22 + z * this._32;
		out[2] = x * this._13 + y * this._23 + z * this._33;
	},

	perspectiveLH: function(vw, vh, z_near, z_far) {
		this._11 = 2.0*z_near/vw;
		this._12 = 0;
		this._13 = 0;
		this._14 = 0;

		this._21 = 0;
		this._22 = 2*z_near/vh;
		this._23 = 0;
		this._24 = 0;

		this._31 = 0;
		this._32 = 0;
		this._33 = z_far/(z_far-z_near);
		this._34 = 1;

		this._41 = 0;
		this._42 = 0;
		this._43 = z_near*z_far/(z_near-z_far);
		this._44 = 0;

		return this;
	},

	lookAtLH: function(aUp, aFrom, aAt) {
		var aX = new Vec3();
		var aY = new Vec3();

		var aZ = new Vec3(aAt.x, aAt.y, aAt.z);
		aZ.sub(aFrom).normalize();

		aX.cp(aUp, aZ).normalize();
		aY.cp(aZ, aX);

		this._11 = aX.x;  this._12 = aY.x;  this._13 = aZ.x;  this._14 = 0;
		this._21 = aX.y;  this._22 = aY.y;  this._23 = aZ.y;  this._24 = 0;
		this._31 = aX.z;  this._32 = aY.z;  this._33 = aZ.z;  this._34 = 0;

		this._41 = -aFrom.dpWith(aX);
		this._42 = -aFrom.dpWith(aY);
		this._43 = -aFrom.dpWith(aZ);
		this._44 = 1;

	    return this;
	},

	mul: function(A, B) {
		this._11 = A._11*B._11  +  A._12*B._21  +  A._13*B._31  +  A._14*B._41;
		this._12 = A._11*B._12  +  A._12*B._22  +  A._13*B._32  +  A._14*B._42;
		this._13 = A._11*B._13  +  A._12*B._23  +  A._13*B._33  +  A._14*B._43;
		this._14 = A._11*B._14  +  A._12*B._24  +  A._13*B._34  +  A._14*B._44;

		this._21 = A._21*B._11  +  A._22*B._21  +  A._23*B._31  +  A._24*B._41;
		this._22 = A._21*B._12  +  A._22*B._22  +  A._23*B._32  +  A._24*B._42;
		this._23 = A._21*B._13  +  A._22*B._23  +  A._23*B._33  +  A._24*B._43;
		this._24 = A._21*B._14  +  A._22*B._24  +  A._23*B._34  +  A._24*B._44;

		this._31 = A._31*B._11  +  A._32*B._21  +  A._33*B._31  +  A._34*B._41;
		this._32 = A._31*B._12  +  A._32*B._22  +  A._33*B._32  +  A._34*B._42;
		this._33 = A._31*B._13  +  A._32*B._23  +  A._33*B._33  +  A._34*B._43;
		this._34 = A._31*B._14  +  A._32*B._24  +  A._33*B._34  +  A._34*B._44;

		this._41 = A._41*B._11  +  A._42*B._21  +  A._43*B._31  +  A._44*B._41;
		this._42 = A._41*B._12  +  A._42*B._22  +  A._43*B._32  +  A._44*B._42;
		this._43 = A._41*B._13  +  A._42*B._23  +  A._43*B._33  +  A._44*B._43;
		this._44 = A._41*B._14  +  A._42*B._24  +  A._43*B._34  +  A._44*B._44;

		return this;
	},

	translate: function(x, y, z) {
		this._11 = 1;  this._12 = 0;  this._13 = 0;  this._14 = 0;
		this._21 = 0;  this._22 = 1;  this._23 = 0;  this._24 = 0;
		this._31 = 0;  this._32 = 0;  this._33 = 1;  this._34 = 0;

		this._41 = x;  this._42 = y;  this._43 = z;  this._44 = 1;
		return this;
	},

	transpose33: function() {
		var t;

		t = this._12;
		this._12 = this._21;
		this._21 = t;

		t = this._13;
		this._13 = this._31;
		this._31 = t;

		t = this._23;
		this._23 = this._32;
		this._32 = t;

		return this;
	},

	// OpenGL style rotation
	glRotate: function(angle, x, y, z) {
		var s = Math.sin( angle );
		var c = Math.cos( angle );

		var xx = x * x;
		var yy = y * y;
		var zz = z * z;
		var xy = x * y;
		var yz = y * z;
		var zx = z * x;
		var xs = x * s;
		var ys = y * s;
		var zs = z * s;
		var one_c = 1.0 - c;
/*
		this._11 = (one_c * xx) + c;
		this._21 = (one_c * xy) - zs;
		this._31 = (one_c * zx) + ys;
		this._41 = 0;

		this._12 = (one_c * xy) + zs;
		this._22 = (one_c * yy) + c;
		this._32 = (one_c * yz) - xs;
		this._42 = 0;

		this._13 = (one_c * zx) - ys;
		this._23 = (one_c * yz) + xs;
		this._33 = (one_c * zz) + c;
		this._43 = 0;

		this._14 = 0;
		this._24 = 0;
		this._34 = 0;
		this._44 = 1;
*/

		this._11 = (one_c * xx) + c;
		this._12 = (one_c * xy) - zs;
		this._13 = (one_c * zx) + ys;
		this._14 = 0;

		this._21 = (one_c * xy) + zs;
		this._22 = (one_c * yy) + c;
		this._23 = (one_c * yz) - xs;
		this._24 = 0;

		this._31 = (one_c * zx) - ys;
		this._32 = (one_c * yz) + xs;
		this._33 = (one_c * zz) + c;
		this._34 = 0;

		this._41 = 0;
		this._42 = 0;
		this._43 = 0;
		this._44 = 1;

		return this;
	}

}

// matrix 2x2
function M22()
{
	this._11 = 1;
	this._12 = 0;
	this._21 = 0;
	this._22 = 1;
}

M22.prototype.getInvert = function()
{
	var out = new M22();
	var det = this._11 * this._22 - this._12 * this._21;
	if (det > -0.0001 && det < 0.0001)
		return null;

	out._11 = this._22 / det;
	out._22 = this._11 / det;

	out._12 = -this._12 / det;
	out._21 = -this._21 / det;

	return out;
}


		</script>

		<script type="text/javascript">
        function TouchApp()
        {
            var _this = this;
            this.mTickCount = 0;
            this.mLoadCount = 2;

            this.canvas = document.getElementById("cv");
            P3D.g = this.canvas.getContext("2d");

            this.vUP   = new Vec3(0, 1, 0);
            this.vAT   = new Vec3(0, 0, 0);
            this.mEye  = new Vec3(1, 0, 15);
            this.mEyeA = new Vec3(0, 0, 20);

            this.mViewport = {};
            this.mViewport.w = 480;
            this.mViewport.h = 300;
            this.mViewport.ow = 240;
            this.mViewport.oh = 150;

            this.mProjMat  = new M44();
            this.mWorldMat = new M44();
            this.mViewMat  = new M44();
            this.mAllMat   = new M44();

            this.ipod = new iPodModel(MESH_IPOD);
            this.canvas.addEventListener("mousemove", function(e){_this.onMouseMove(e);}, false);

            var tex = new Image();
            this.ipod.texture = tex;
            tex.onload = function(){ _this.start(); };
            tex.src = "http://img.f.hatena.ne.jp/images/fotolife/g/gyuque/20090319/20090319144649.png";

            tex = new Image();
            this.texture2 = tex;
            tex.onload = function(){ _this.start(); };
            tex.src = "http://img.f.hatena.ne.jp/images/fotolife/g/gyuque/20090226/20090226031413.png";
        }

        TouchApp.prototype = {
            start: function() {
                if (--this.mLoadCount > 0) return;

                this.setupTransform();
                this.onInterval();
            },

            onInterval: function() {
                this.mEye.smul(0.7);
                this.mEye.x += this.mEyeA.x * 0.3;
                this.mEye.y += this.mEyeA.y * 0.3;
                this.mEye.z += this.mEyeA.z * 0.3;
                this.updateViewTrans();

                this.mWorldMat.ident();
                this.calcAllTransforms();
                this.transformVertices(MESH_floor);

                this.mWorldMat.glRotate(0.14, 1, 0, 0);
                this.calcAllTransforms();
                this.transformVertices(this.ipod.mesh);

                P3D.clear("#000", this.mViewport.w, this.mViewport.h);
                this.drawFloor();
                this.ipod.render(this);

                this.mTickCount++;
                var _this = this;
                setTimeout(function(){_this.onInterval();}, 20);
            },

            updateViewTrans: function(ry) {
                this.mViewMat.lookAtLH(this.vUP, this.mEye, this.vAT);
            },

            onMouseMove: function(e) {
                this.setEyePosTarget(e.clientX - this.mViewport.ow, e.clientY - this.mViewport.oh);
            },

            setEyePosTarget: function(tx, ty) {
                var R = 20;
                this.mEyeA.y = 30 - ty*0.4;
                if (this.mEyeA.y < -0.7) {
                    R += -0.7 - this.mEyeA.y;
                    this.mEyeA.y = -0.7;
                }
                this.mEyeA.z = Math.cos(tx*0.02) * R;
                this.mEyeA.x = Math.sin(tx*0.02) * R;
            },

            setupTransform: function() {
                this.mWorldMat.ident();
                this.mProjMat.perspectiveLH(8, 5, 4, 900);
                this.mViewMat.ident();
            },

            calcAllTransforms: function() {
                if (!this._mTmpMat) this._mTmpMat = new M44();
                this._mTmpMat.mul(this.mWorldMat, this.mViewMat);
                this.mAllMat.mul(this._mTmpMat, this.mProjMat);
            },

            transformVertices: function(mesh) {
                var i;
                var m = this.mAllMat;
                var hw = this.mViewport.ow;
                var hh = this.mViewport.oh;

                if ((mesh.poss.length % 3) != 0)
                    throw "invalid length";

                var poss = mesh.poss;
                var plen = poss.length/3;

                if (!mesh.tl_poss) {
                    mesh.tl_poss = new Array(plen * 4);
                }
                var tl_poss = mesh.tl_poss;

                var pi = 0, ti = 0, spos = new Array(4), p = new Vec3();
                for (i = 0;i < plen;i++) {
                    p.x = poss[pi  ];
                    p.y = poss[pi+1];
                    p.z = poss[pi+2];
                    pi += 3;

                    m.transVec3(spos, p.x, p.y, p.z);

                    var W = spos[3];
                    spos[0] /= W;
                    spos[1] /= W;
                    spos[2] /= W;

                    spos[0] *= this.mViewport.w;
                    spos[1] *= -this.mViewport.h;
                    spos[0] += hw;
                    spos[1] += hh;

                    tl_poss[ti++] = spos[0];
                    tl_poss[ti++] = spos[1];
                    tl_poss[ti++] = spos[2];
                    ti++;
                }
            },

            drawFloor: function() {
                P3D.texture = this.texture2;
// console.log(MESH_floor.tl_poss[2] + "  " + MESH_floor.tl_poss[6])
                P3D.drawByIndexBuffer(MESH_floor.tl_poss, MESH_floor.face_groups[0], MESH_floor.texcoords, -1, true);
            }
        }

        function iPodModel(mesh) {
            this.texture = null;
            this.mesh = mesh;
            this.uvbuf = new Array(124);
            this.sphmap_uvbuf = new Array(124);

            this.uvbuf[112] = 0;
            this.uvbuf[113] = 0;

            this.uvbuf[114] = 0;
            this.uvbuf[115] = 0.875;

            this.uvbuf[116] = 0.3333;
            this.uvbuf[117] = 0;

            this.uvbuf[118] = 0.3333;
            this.uvbuf[119] = 0.875;

            this.uvbuf[120] = 0;
            this.uvbuf[121] = 0.4375;

            this.uvbuf[122] = 0.3333;
            this.uvbuf[123] = 0.4375;
        }

        iPodModel.prototype = {
            render: function(renderContext) {
                P3D.texture = this.texture;
                P3D.drawByIndexBuffer(this.mesh.tl_poss, this.mesh.face_groups[0], this.uvbuf, -1);

                this.setSphereMapUVs(2, renderContext);
                P3D.drawByIndexBuffer(this.mesh.tl_poss, this.mesh.face_groups[2], this.sphmap_uvbuf, -1);
                P3D.texture = null;

                var face_plate = this.mesh.face_groups[1];
                var vi, i, len = face_plate.length;
                for (i = 0;i < len;i += 3) {
                    vi = face_plate[i];
                    this.uvbuf[vi << 1] = "#000";
                }

                P3D.drawByIndexBuffer(this.mesh.tl_poss, this.mesh.face_groups[1], this.uvbuf, -1);
            },

            setSphereMapUVs: function(gi, renderContext) {
                var faces = this.mesh.face_groups[gi];
                var poss  = this.mesh.poss;
                var i, len = faces.length/3;
                var v0, v1, v2, vN, vNt;
                var vlen = poss.length;

                if (!this.mesh.N_list) {
// generate N vector
                    vN = new Vec3();
                    var vA = new Vec3(), vB = new Vec3();
                    this.mesh.N_list = new Array( poss.length );

                    for (i = 0;i < vlen;i++) {
                        this.mesh.N_list[i] = new Vec3(0, 0, 0);
                    }

                    for (i = 0;i < len;i++) {
                        v0 = faces[i*3  ];
                        v1 = faces[i*3+1];
                        v2 = faces[i*3+2];

                        vA.x = poss[v1*3  ] - poss[v0*3  ];
                        vA.y = poss[v1*3+1] - poss[v0*3+1];
                        vA.z = poss[v1*3+2] - poss[v0*3+2];

                        vB.x = poss[v2*3  ] - poss[v1*3  ];
                        vB.y = poss[v2*3+1] - poss[v1*3+1];
                        vB.z = poss[v2*3+2] - poss[v1*3+2];

                        vN.cp(vB, vA).normalize();

                        this.mesh.N_list[v0].add(vN);
                        this.mesh.N_list[v1].add(vN);
                        this.mesh.N_list[v2].add(vN);
                    }

                    for (i = 0;i < vlen;i++) {
                        this.mesh.N_list[i].normalize();
                    }

// generate N vector
                }
/*
for (i = 0;i < vlen;i++) {
	vN = this.mesh.N_list[i];
	this.sphmap_uvbuf[i<<1     ] = (vN.y < -0.3) ? "#700" : (vN.y < 0.2) ? "#a00" : (vN.y < 0.4) ? "#c00" : "#f00"
}
return;
*/
                var spos = [0,0,0,0];
                var viewRot = (new M44()).copyFrom(renderContext.mViewMat).transpose33();
                var worldRot = (new M44()).copyFrom(renderContext.mWorldMat);
                viewRot._41 = viewRot._42 = viewRot._43 = 0;
                viewRot.transVec3(spos, 0, 0, 1);

                var in_vector = (new Vec3(spos[0], spos[1], spos[2])).normalize();
                var rN = new Vec3(), rlen;

                vN = new Vec3();
                for (i = 0;i < vlen;i++) {
                    vNt = this.mesh.N_list[i];
                    worldRot.transVec3(spos, vNt.x, vNt.y, vNt.z);
                    vN.x = spos[0];
                    vN.y = spos[1];
                    vN.z = spos[2];

                    rlen = vN.dpWith(in_vector) * -2;

                    rN.copyFrom(in_vector);

                    rN.x += vN.x * rlen;
                    rN.y += vN.y * rlen;
                    rN.z += vN.z * rlen;

                    this.sphmap_uvbuf[i<<1     ] = rN.x/2*0.666 + 0.666666;
                    this.sphmap_uvbuf[(i<<1)+ 1] = -rN.y/2.01 + 0.5;
                }
            }
        }

            
		</script>

		<style type="text/css">
body {
	margin: 0;
	padding: 0;
	background-color: #333;
	color: #fff;
	-moz-user-select: none;
	-webkit-user-select: none;
}

#renderer-selection {
	padding-left: 2em;
}

#cv {
	background: #000;
	margin: 0;
	display: block;
}

p {
	padding-left: 1em;
	margin: 8px;
	font-family: Arial, sans-serif;
}

div#main {
	width: 480px;
	background-color: #222;
	margin: 0;
	padding-bottom: 1em;
}

ul.navi-sub,
ul.navi-sub li {
	display: inline;
}

ul.navi-sub li.selected {
	background: #444;
}

ul.navi-sub {
	margin: 3px;
	padding: 0;
}

ul.navi-sub li {
	padding: 3px;
}

ul.navi {
	margin-top: 0;
}

ul.navi li {
	display: inline;
	padding: 5px 1em;
}

ul.navi .selected {
	background: #222;
	color: #fff;
}

ul.navi a, ul.navi-sub a {
	color: #f80;
}

.newmark{font-size:9px; color: #ef0;}

address {width: 470px; text-align: right;}
a img {border: none;}
		</style>

		<title>js touch</title>
	</head>
	<body onload="void( new TouchApp() );">
		<div id="main">

			<canvas id="cv" width="480" height="300"></canvas>
			<p style="height:75px;">
<a href="http://www.chromeexperiments.com/detail/js-touch/"><img align="left" src="http://www.d4.dion.ne.jp/~uym/images/chexp.gif" alt="ChromeExperiments" /></a>
"3D on 2D Canvas" demo 3<br />(Sphere Environment Mapping)</p>
			<div id="renderer-selection">
				Renderer:
				<ul class="navi-sub">
					<li class="selected">2D Canvas</li>
					<li><a href="touch-opera-gecko.html">Opera 3D or Gecko 3D</a></li>

					<li><a href="touch-o3d.html">O3D</a></li>
					<li><a href="touch-wgl.html">WebGL <span class="newmark">NEW</span></a></li>
				</ul>
			</div>
		</div>
		<ul class="navi">
			<li><a href="./">demo 1</a></li>

			<li><a href="miku.html">demo 2</a></li>
			<li class="selected">demo 3</li>
		</ul>
	</body>
</html>
